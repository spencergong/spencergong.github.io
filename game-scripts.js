var Vr=pc.createScript("vr");
Vr.attributes.add("buttonVr",{type:"entity",title:"VR Button"}),
Vr.attributes.add("elementUnsupported",{type:"entity",title:"Unsupported Message"}),
Vr.attributes.add("cameraEntity",{type:"entity",title:"Camera"}),

Vr.prototype.initialize=function(){
    this.app.xr.on("available:"+pc.XRTYPE_VR,this.checkButton,this),
    this.app.xr.on("start",this.checkButton,this),
    this.app.xr.on("end",this.checkButton,this),
    this.buttonVr.element.on("click",(function(){
        this.sessionStart()}),this),
        this.app.keyboard.on("keydown",(function(t){
            t.key===pc.KEY_ESCAPE&&this.app.xr.active&&this.app.xr.end()}),this),
            this.checkButton()},

Vr.prototype.checkButton=function(){
    if(this.app.xr.supported)
       if(this.elementUnsupported.enabled=!1,this.app.xr.active)
             this.buttonVr.enabled=!1;
       else{
           this.buttonVr.enabled=!0;
           var t=this.app.xr&&!this.app.xr.active&&this.app.xr.isAvailable(pc.XRTYPE_VR);
           this.buttonVr.element.opacity=t?.2:.1,
           this.buttonVr.children[0].element.opacity=t?1:.2}
    else 
       this.buttonVr.enabled=!1,
       this.elementUnsupported.enabled=!0},

Vr.prototype.sessionStart=function(){
    this.app.xr.supported&&(this.app.xr.active||this.app.xr.isAvailable(pc.XRTYPE_VR)&&this.cameraEntity.camera.startXr(pc.XRTYPE_VR,pc.XRSPACE_LOCAL))};
    
    
var Controllers=pc.createScript("controllers");Controllers.attributes.add("controllerTemplate",{type:"entity",title:"Controller Template"}),Controllers.attributes.add("cameraParent",{type:"entity",title:"Camera Parent"}),Controllers.prototype.initialize=function(){this.app.xr.input.on("add",(function(t){var e=this.controllerTemplate.clone();e.script.controller.setInputSource(t),e.reparent(this.cameraParent),e.enabled=!0}),this)};var Controller=pc.createScript("controller");Controller.prototype.initialize=function(){this.vecA=new pc.Vec3,this.vecB=new pc.Vec3,this.matA=new pc.Mat4,this.quat=new pc.Quat,this.color=new pc.Color(1,1,1),this.modelEntity=this.entity.findByName("model"),this.hoverEntity=null,this.ray=new pc.Ray,this.targetPointerSize=2,this.targetTeleportable=!1,this.pointer=this.entity.findByName("pointer"),this.pointer.element.material.depthTest=!1,this.hoverPoint=new pc.Vec3,this.pointerDistance=3},Controller.prototype.setInputSource=function(t){this.inputSource=t,this.inputSource.once("remove",this.onRemove,this),this.on("hover",this.onHover,this),this.on("blur",this.onBlur,this),this.inputSource.on("select",this.onSelect,this)},Controller.prototype.onRemove=function(){this.entity.destroy()},Controller.prototype.onSelect=function(){if(this.app.fire("object:pick",this),this.hoverEntity)if(this.targetTeleportable)this.app.fire("controller:teleport",this.hoverPoint);else if(this.hoverEntity.tags.has("interactive")){var t=this.hoverEntity.model.meshInstances[0];t.pickedColor||(t.pickedColor=new pc.Color),t.pickedColor.set(Math.random(),Math.random(),Math.random()),t.setParameter("material_diffuse",t.pickedColor.data3)}},Controller.prototype.onHover=function(t,e){this.hoverEntity=t,this.hoverPoint.copy(e),this.targetPointerSize=16,this.targetTeleportable=this.hoverEntity.tags.has("teleportable")},Controller.prototype.onBlur=function(){this.hoverEntity=null,this.targetPointerSize=4,this.targetTeleportable=!1},Controller.prototype.update=function(t){this.ray.origin.copy(this.inputSource.ray.origin),this.ray.direction.copy(this.inputSource.ray.direction);var e=this.entity.parent.getPosition(),i=this.entity.parent.getRotation();if(i.transformVector(this.ray.origin,this.ray.origin),this.ray.origin.add(e),i.transformVector(this.ray.direction,this.ray.direction),this.app.fire("object:pick",this),this.vecA.copy(this.ray.origin),this.vecB.copy(this.ray.direction),this.vecB.scale(1e3).add(this.vecA),this.inputSource.selecting?this.color.set(0,1,0):this.color.set(1,1,1),this.app.renderLine(this.vecA,this.vecB,this.color),this.inputSource.grip&&(this.modelEntity.enabled=!0,this.entity.setLocalPosition(this.inputSource.position),this.entity.setLocalRotation(this.inputSource.rotation)),this.hoverEntity){var o=this.vecA.copy(this.hoverPoint).sub(this.ray.origin).length();this.pointerDistance+=.3*(o-this.pointerDistance)}this.vecA.copy(this.ray.direction).scale(this.pointerDistance).add(this.ray.origin),this.pointer.setPosition(this.vecA);var r=this.targetPointerSize*(this.targetTeleportable?8:1);this.pointer.element.width!==r&&(this.pointer.element.width+=.3*(r-this.pointer.element.width),Math.abs(this.pointer.element.width-r)<=1&&(this.pointer.element.width=r),this.pointer.element.height=this.pointer.element.width),this.targetTeleportable?this.pointer.setEulerAngles(-90,0,0):this.app.xr.camera&&(this.pointer.lookAt(this.app.xr.camera.getPosition(),pc.Vec3.DOWN),this.pointer.rotateLocal(0,180,0));var n=this.inputSource.gamepad;n&&(this.inputSource.handedness===pc.XRHAND_LEFT&&(n.axes[3]||n.axes[2])?this.app.fire("controller:move",n.axes[2],n.axes[3],t):this.inputSource.handedness===pc.XRHAND_RIGHT&&n.axes[2]&&this.app.fire("controller:rotate",-n.axes[2],t))};var ObjectPicker=pc.createScript("objectPicker");ObjectPicker.prototype.initialize=function(){this.entities=this.app.root.findByTag("pickable"),this.vec3A=new pc.Vec3,this.vec3B=new pc.Vec3,this.app.on("object:pick",this.pick,this)},ObjectPicker.prototype.pick=function(i){for(var e=null,t=1/0,c=0;c<this.entities.length;c++){if(this.entities[c].model)if(this.entities[c].model.meshInstances[0].aabb.intersectsRay(i.ray,this.vec3A)){var s=this.vec3A.distance(i.ray.origin);s<t&&(t=s,e=this.entities[c],this.vec3B.copy(this.vec3A))}}e?i.fire("hover",e,this.vec3B):i.hoverEntity&&i.fire("blur")};var CameraController=pc.createScript("camera-controller");CameraController.attributes.add("height",{type:"number",default:1.6,placeholder:"m",title:"Height from Floor"}),CameraController.attributes.add("movementSpeed",{type:"number",default:1.5,placeholder:"m/s",title:"Movement Speed"}),CameraController.attributes.add("rotateSpeed",{type:"number",default:45,placeholder:"Â°",title:"Rotation Speed"}),CameraController.attributes.add("rotateThreshold",{type:"number",default:.5,min:0,max:1,title:"Rotation thumbstick threshold"}),CameraController.attributes.add("rotateResetThreshold",{type:"number",default:.25,min:0,max:1,title:"Rotation thumbstick reset threshold"}),CameraController.attributes.add("camera",{type:"entity",title:"Camera Entity"}),CameraController.prototype.initialize=function(){this.vec2A=new pc.Vec2,this.vec2B=new pc.Vec2,this.vec3A=new pc.Vec3,this.lastRotate=0,this.lastRotateValue=0,this.app.on("controller:teleport",this.onTeleport,this),this.app.on("controller:move",this.onMove,this),this.app.on("controller:rotate",this.onRotate,this)},CameraController.prototype.onTeleport=function(t){this.app.xr.type!==pc.XRTYPE_AR&&(this.vec3A.copy(this.camera.getLocalPosition()).scale(-1),this.entity.setPosition(t),this.entity.translate(0,this.height,0),this.entity.translateLocal(this.vec3A))},CameraController.prototype.onMove=function(t,e,a){if(this.vec2A.set(t,e),this.vec2A.length()){this.vec2A.normalize(),this.vec2B.x=this.camera.forward.x,this.vec2B.y=this.camera.forward.z,this.vec2B.normalize();var o=Math.atan2(this.vec2B.x,this.vec2B.y)-Math.PI/2,i=this.vec2A.x*Math.sin(o)-this.vec2A.y*Math.cos(o);this.vec2A.y=this.vec2A.y*Math.sin(o)+this.vec2A.x*Math.cos(o),this.vec2A.x=i,this.vec2A.scale(this.movementSpeed),this.entity.translate(this.vec2A.x*a,0,this.vec2A.y*a)}},CameraController.prototype.onRotate=function(t,e){if(!(Date.now()-this.lastRotate<200)){if(0!==this.lastRotateValue)if(this.lastRotateValue>0){if(!(t<this.rotateResetThreshold))return;this.lastRotateValue=0}else{if(!(t>-this.rotateResetThreshold))return;this.lastRotateValue=0}Math.abs(t)>this.rotateThreshold&&(this.lastRotateValue=Math.sign(t),this.vec3A.copy(this.camera.getLocalPosition()),this.entity.translateLocal(this.vec3A),this.entity.rotateLocal(0,Math.sign(t)*this.rotateSpeed,0),this.entity.translateLocal(this.vec3A.scale(-1)))}};